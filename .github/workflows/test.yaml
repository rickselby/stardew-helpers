name: Test

on:
  push:

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  webpack:
    name: Build Vue components
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
      - run: bundle exec rake npm:install
      - run: bundle exec rake webpack
      - uses: actions/upload-artifact@v3
        with:
          name: webpack-components
          path: |
            public/css/**
            public/js/**
            public/mainfest.json

  bundler-audit:
    name: Bundler Audit
    runs-on: ubuntu-latest
    steps:
      - uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
      - run: bundle exec rake bundle:audit:update
      - run: bundle exec rake bundle:audit:check

  rspec:
    name: RSpec tests
    runs-on: ubuntu-latest
    needs: [ webpack ]
    steps:
      - uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
      - uses: actions/download-artifact@v3
        with:
          name: webpack-components
          path: public
      - run: bundle exec rake spec

  rubocop:
    name: Rubocop
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
      - run: bundle exec rake rubocop
